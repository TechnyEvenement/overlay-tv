<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Overlay Vitesse Live</title>

<style>
/* ===== DESIGN BROADCAST TV ===== */
body {
  margin: 0;
  background: transparent;
  font-family: Arial, Helvetica, sans-serif;
}

#overlay {
  position: fixed;
  bottom: 40px;
  left: 40px;
  background: #ffd200;
  color: #000;
  padding: 16px 20px;
  border-radius: 6px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.4);
  min-width: 260px;
}

.line {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.label {
  font-weight: bold;
  font-size: 18px;
  opacity: 0.85;
}

.value {
  font-weight: bold;
  font-size: 34px;
}

.unit {
  font-size: 18px;
  margin-left: 6px;
}
</style>
</head>

<body>

<div id="overlay">
  <div class="line">
    <span class="label">VITESSE</span>
    <span>
      <span class="value" id="speed">0.0</span>
      <span class="unit">km/h</span>
    </span>
  </div>
</div>

<script>
// ===== HAVERSINE (distance GPS) =====
function haversine(p1, p2) {
  const R = 6371; // km
  const dLat = (p2.lat - p1.lat) * Math.PI / 180;
  const dLon = (p2.lon - p1.lon) * Math.PI / 180;

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(p1.lat * Math.PI / 180) *
    Math.cos(p2.lat * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

// ===== VARIABLES =====
let lastPos = null;
let lastTime = null;
let samples = []; // pour le lissage

// ===== CALCUL VITESSE =====
function calculVitesse(pos) {
  if (!lastPos) {
    lastPos = pos;
    lastTime = Date.now();
    return 0;
  }

  const now = Date.now();
  const dt = (now - lastTime) / 1000;

  const d = haversine(
    { lat: lastPos.coords.latitude, lon: lastPos.coords.longitude },
    { lat: pos.coords.latitude, lon: pos.coords.longitude }
  );

  lastPos = pos;
  lastTime = now;

  return dt > 0 ? (d / dt) * 3.6 : 0; // km/h
}

// ===== GPS LIVE =====
navigator.geolocation.watchPosition(pos => {

  let vitesse;

  if (pos.coords.speed !== null && pos.coords.speed > 0) {
    // vitesse GPS brute
    vitesse = pos.coords.speed * 3.6;
  } else {
    // vitesse calculÃ©e
    vitesse = calculVitesse(pos);
  }

  // LISSAGE (moyenne glissante)
  samples.push(vitesse);
  if (samples.length > 5) samples.shift();

  const vitesseLisse =
    samples.reduce((a, b) => a + b, 0) / samples.length;

  document.getElementById("speed").textContent =
    vitesseLisse.toFixed(1);

}, error => {
  console.error("Erreur GPS :", error);
}, {
  enableHighAccuracy: true,
  maximumAge: 500,
  timeout: 10000
});
</script>

</body>
</html>
